{% extends "base.html" %} {% block title %}Results of {{ video_name2 }}{% endblock %}

{% block content %}
<div>
    <div class="py-2 px-6 bg-slate-200 dark:bg-[#121212] flex items-center fixed top-0 w-full">
        <button type="button" class="text-lg text-black dark:text-white" id="menuToggleButton">
            <i class="ri-menu-line cursor-pointer"></i>
        </button>
        <div>
            <span class="text-m text-black dark:text-white ml-4">Results</span>
        </div>       
    </div>

    <!-- SUMMARY -->
    <div class="mt-5 pt-5 flex justify-center">
        <table id="summary" class="table-auto text-center ml-[50px] mr-[50px] mt-4">
            <thead class="text-white">
                <tr class="bg-red-600 dark:bg-slate-700 text-lg">
                    <th class="px-2 py-1">Interpretation of " {{ video_name2 }} "</th>
                </tr>
            </thead>
            <tbody class="text-gray-900 dark:text-white text-sm">
                <tr>
                    <td class="px-2 py-2">
                        As of today, this video has received {{ positive_count2 }} positive comments, {{ negative_count2 }} negative comments, and {{ neutral_count2 }} neutral comments. The most frequently used words are: 
                        {% for word in frequent_words2 %}
                            {% if loop.last %}
                                and '{{ word[0] }}'
                            {% else %}
                                '{{ word[0] }}',
                            {% endif %}
                        {% endfor %} which were used 
                        {% for word in frequent_words2 %} 
                            {% if loop.last %}
                                and {{ word[1] }} times,
                            {% else %}
                                {{ word[1] }},
                            {% endif %}
                        {% endfor %} respectively.
                    </td>
                </tr>
            </tbody>
        </table>
    </div>    
  
    <!-- TABLE FOR COMMENTS -->
    <div class="mt-5 pt-5 flex justify-center">
        <table id="labeled-comments" class="table-auto ml-[50px] mr-[50px] mt-4">
            <thead class="text-white">
                <tr class="bg-red-600 dark:bg-slate-700 text-lg">
                    <th class="px-4 py-1">Comments</th>
                    <th class="px-2 py-1">Sentiments</th>
                </tr>
            </thead>
            <tbody class="text-center text-gray-900 dark:text-white text-sm">
                {% for comment in comments2 %}
                    <tr class="sentiment-row" data-sentiment="{{ comment.sentiment }}">
                        <td class="px-2 py-2">{{ comment.comment }}</td>
                        <td class="px-2 py-2">{{ comment.sentiment }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div id="pagination-controls" class="flex justify-center mt-4"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const rowsPerPage = 5;
            const table = document.getElementById('labeled-comments');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const paginationControls = document.getElementById('pagination-controls');
            let currentPage = 1;

            function renderTable() {
                tbody.innerHTML = '';
                const start = (currentPage - 1) * rowsPerPage;
                const end = start + rowsPerPage;
                const paginatedRows = rows.slice(start, end);
                paginatedRows.forEach(row => tbody.appendChild(row));
            }

            function renderPaginationControls() {
                paginationControls.innerHTML = '';
                const totalPages = Math.ceil(rows.length / rowsPerPage);

                if (currentPage > 1) {
                    const prevButton = document.createElement('button');
                    prevButton.textContent = '←';
                    prevButton.classList.add('rounded', 'px-2', 'py-1', 'mx-1', 'bg-gray-200', 'dark:bg-gray-700', 'text-black', 'dark:text-white');
                    prevButton.addEventListener('click', () => {
                        if (currentPage > 1) {
                            currentPage--;
                            renderTable();
                            renderPaginationControls();
                        }
                    });
                    paginationControls.appendChild(prevButton);
                }

                const startPage = Math.max(1, currentPage - 1);
                const endPage = Math.min(totalPages, startPage + 2);

                for (let i = startPage; i <= endPage; i++) {
                    const pageButton = document.createElement('button');
                    pageButton.textContent = i;
                    pageButton.classList.add('rounded', 'px-2', 'py-1', 'mx-1', 'bg-gray-200', 'dark:bg-gray-700', 'text-black', 'dark:text-white');
                    if (i === currentPage) {
                        pageButton.classList.add('font-bold');
                    }
                    pageButton.addEventListener('click', () => {
                        currentPage = i;
                        renderTable();
                        renderPaginationControls();
                    });
                    paginationControls.appendChild(pageButton);
                }

                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.classList.add('mx-1', 'text-black', 'dark:text-white');
                    paginationControls.appendChild(ellipsis);
                }

                if (endPage < totalPages) {
                    const lastPageButton = document.createElement('button');
                    lastPageButton.textContent = totalPages;
                    lastPageButton.classList.add('rounded', 'px-2', 'py-1', 'mx-1', 'bg-gray-200', 'dark:bg-gray-700', 'text-black', 'dark:text-white');
                    if (totalPages === currentPage) {
                        lastPageButton.classList.add('font-bold');
                    }
                    lastPageButton.addEventListener('click', () => {
                        currentPage = totalPages;
                        renderTable();
                        renderPaginationControls();
                    });
                    paginationControls.appendChild(lastPageButton);
                }

                if (currentPage < totalPages) {
                    const nextButton = document.createElement('button');
                    nextButton.textContent = '→';
                    nextButton.classList.add('rounded', 'px-2', 'py-1', 'mx-1', 'bg-gray-200', 'dark:bg-gray-700', 'text-black', 'dark:text-white');
                    nextButton.addEventListener('click', () => {
                        if (currentPage < totalPages) {
                            currentPage++;
                            renderTable();
                            renderPaginationControls();
                        }
                    });
                    paginationControls.appendChild(nextButton);
                }
            }

            renderTable();
            renderPaginationControls();
        });
    </script>

    <div class="flex justify-center mb-5 space-x-5 items-center">
        <div class="flex justify-center mt-[20px] ml-[50px] mr-4">
            <table id="frequent-words" class="table-auto text-center text-sm w-full">
                <thead class="text-white">
                    <tr class="bg-red-600 dark:bg-slate-700">
                        <th class="px-2 py-1">Word</th>
                        <th class="px-2 py-1">Count</th>
                        <th class="px-2 py-1">Sentiment</th>
                    </tr>
                </thead>
                <tbody class="text-gray-900 dark:text-white">
                    {% for word in frequent_words2 %}
                    <tr>
                        <td class="px-2 py-1">{{ word[0] }}</td>
                        <td class="px-2 py-1">{{ word[1] }}</td>
                        <td class="py-1">{{ word[2] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mt-[20px] ml-4 mr-[50px]">
            <canvas id="pieChart" width="350px" height="350px"></canvas>
        </div>
    </div>

    <script>
        async function fetchSentimentData(urlId2) {
            const response = await fetch(`/api/sentiment/${urlId2}`);
            const data = await response.json();
            return data;
        }
        async function updatePieChart(urlId2) {
            const data = await fetchSentimentData(urlId2);
            const ctx = document.getElementById('pieChart').getContext('2d');
            const pieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Negative', 'Positive', 'Neutral'],
                    datasets: [{
                        label: 'Sentiment Analysis',
                        data: [data.negative, data.positive, data.neutral],
                        backgroundColor: ['#b91c1c', '#1d4ed8', '#fbbf24'],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'left',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem2) {
                                    return tooltipItem2.label + ': ' + tooltipItem2.raw;
                                }
                            }
                        }
                    }
                }
            });
        }

        function getUrlParameter2(name2) {
            name2 = name2.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex2 = new RegExp('[\\?&]' + name2 + '=([^&#]*)');
            const results2 = regex2.exec(location.search);
            return results2 === null ? '' : decodeURIComponent(results2[1].replace(/\+/g, ' '));
        }

        function getUrlPathParameter2(position2) {
            const pathSegments2 = window.location.pathname.split('/');
            return pathSegments2[position2] || null;
        }

        window.onload = function() {
            const urlId2 = getUrlPathParameter2(2);
            if (urlId2) {
                updatePieChart(urlId2);
            } else {
                console.error('url_id2 parameter is missing in the URL');
            }
        };
    </script>

    <div class="rounded ml-[50px] mr-[50px] mt-4 bg-red-600 dark:bg-slate-700 p-1">
        <a class="text-white font-bold ml-2">Word Cloud</a>
    </div>
    <div class="pb-8">
        <div class="flex justify-center">
            <div class="mt-[20px] ml-[50px] mr-4">
                {% if positive_img_str2 %}
                <img class="w-full rounded" src="data:image/png;base64,{{ positive_img_str2 }}">
                {% else %}
                <p class="text-black dark:text-white text-center mt-2">No positive words found.</p>
                {% endif %}
                <p class="text-black dark:text-white text-center mt-2">Positive</p>
            </div>
            <div class="mt-[20px] ml-4 mr-[50px]">
                {% if negative_img_str2 %}
                <img class="w-full rounded" src="data:image/png;base64,{{ negative_img_str2 }}">
                {% else %}
                <p class="text-black dark:text-white text-center mt-2">No negative words found.</p>
                {% endif %}
                <p class="text-black dark:text-white text-center mt-2">Negative</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
