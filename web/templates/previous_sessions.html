{% extends "base.html" %} {% block title %}Results of {{ youtube_url.video_name }}{% endblock %}

{% block content %}
<div>
<div class="py-2 px-6 bg-slate-200 dark:bg-[#121212] flex items-center fixed top-0 w-full">
    <button type="button" class="text-lg text-black dark:text-white" id="menuToggleButton">
        <i class="ri-menu-line cursor-pointer"></i>
    </button>
    <div>
        <span class="text-m text-black dark:text-white ml-4">Results</span>
    </div>       
</div>

<!-- SUMMARY -->
<div class="mt-5 pt-5 flex justify-center">
  <table id="summary" class="table-auto text-center ml-[50px] mr-[50px] mt-4">
    <thead class="text-white">
      <tr class="bg-red-600 dark:bg-slate-700 text-lg">
        <th class="px-2 py-1">Comments Summary of " {{ youtube_url.video_name }} "</th>
      </tr>
    </thead>
    <!-- Values are from Summarized_comments table in the database, summary column, url_id = id (youtube_url id) -->
    <tbody class="text-gray-900 dark:text-white text-sm">
      <tr>
        <td class="px-2 py-2">{{ summary }}</td>
      </tr>
    </tbody>
  </table>
</div>    
  
<!-- TABLE FOR COMMENTS -->
<div class="mt-5 pt-5 flex justify-center">
  <table id="labeled-comments" class="table-auto ml-[50px] mr-[50px] mt-4">
    <thead class="text-white">
      <tr class="bg-red-600 dark:bg-slate-700 text-lg">
        <th class="px-4 py-1">Comments</th>
        <th class="px-2 py-1">Sentiments</th>
      </tr>
    </thead>
    <tbody class="text-center text-gray-900 dark:text-white text-sm">
      {% for labeled in sentiment_analysis %}
      <tr>
        <td class="px-2 py-2">{{ labeled.comment }}</td>
        <td class="px-2 py-2">{{ labeled.sentiment }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<div id="pagination-controls" class="flex justify-center mt-4"></div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const rowsPerPage = 5;
    const table = document.getElementById('labeled-comments');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const paginationControls = document.getElementById('pagination-controls');
    let currentPage = 1;

    function renderTable() {
      tbody.innerHTML = '';
      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const paginatedRows = rows.slice(start, end);
      paginatedRows.forEach(row => tbody.appendChild(row));
    }

    function renderPaginationControls() {
      paginationControls.innerHTML = '';
      const totalPages = Math.ceil(rows.length / rowsPerPage);
      for (let i = 1; i <= totalPages; i++) {
        const button = document.createElement('button');
        button.textContent = i;
        button.classList.add('rounded', 'px-2', 'py-1', 'mx-1', 'bg-gray-200', 'dark:bg-gray-700', 'text-black', 'dark:text-white');
        if (i === currentPage) {
          button.classList.add('font-bold');
        }
        button.addEventListener('click', () => {
          currentPage = i;
          renderTable();
          renderPaginationControls();
        });
        paginationControls.appendChild(button);
      }
    }

    renderTable();
    renderPaginationControls();
  });
</script>

<div class="flex justify-center mb-5 space-x-5 items-center">
  <!-- Table for Word Count -->
  <div class="flex justify-center mt-[20px] ml-[50px] mr-4">
    <table id="frequent-words" class="table-auto text-center text-sm w-full">
      <thead class="text-white">
        <tr class="bg-red-600 dark:bg-slate-700">
          <th class="px-2 py-1">Word</th>
          <th class="px-2 py-1">Count</th>
          <th class="px-2 py-1">Sentiment</th>
        </tr>
      </thead>
      <tbody class="text-gray-900 dark:text-white">
        {% for word in frequent_words %}
        <tr>
          <td class="px-2 py-1">{{ word.word }}</td>
          <td class="px-2 py-1">{{ word.count }}</td>
          <td class="py-1">{{ word.sentiment }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

<!-- Pie Chart -->
<div class="mt-[20px] ml-4 mr-[50px]">
  <canvas id="pieChart" width="350px" height="350px"></canvas>
</div>

</div>
<!-- Values are from sentiment_counter table. Columns: positive, negative, neutral, url_id = id (youtube_url table) -->
  <script>
    async function fetchSentimentData(urlId) {
      const response = await fetch(`/api/sentiment/${urlId}`);
      const data = await response.json();
      return data;
    }
    async function updatePieChart(urlId) {
      const data = await fetchSentimentData(urlId);
    const ctx = document.getElementById('pieChart').getContext('2d');
    const pieChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['Negative', 'Positive', 'Neutral'],
        datasets: [{
          label: 'Sentiment Analysis',
          data: [data.negative, data.positive, data.neutral],
          backgroundColor: ['#b91c1c', '#1d4ed8', '#fbbf24'], // Tailwind colors
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'left',
          },
          tooltip: {
            callbacks: {
              label: function(tooltipItem) {
                return tooltipItem.label + ': ' + tooltipItem.raw;
              }
            }
          }
        }
      }
    });
  }

  function getUrlParameter(name) {
      name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
      const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
      const results = regex.exec(location.search);
      return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
  }

  function getUrlPathParameter(position) {
      const pathSegments = window.location.pathname.split('/');
      return pathSegments[position] || null;
  }

  window.onload = function() {
      const urlId = getUrlPathParameter(2);
      if (urlId) {
          updatePieChart(urlId);
      } else {
          console.error('url_id parameter is missing in the URL');
      }
  };
  </script>

  <!-- TO DO -->
  <div class="rounded ml-[50px] mr-[50px] mt-4 bg-red-600 dark:bg-slate-700 p-1">
    <a class="text-white font-bold ml-2">Word Cloud</a>
  </div>     
  <div class="pb-8">
    <div class="flex justify-center">
      <div class="mt-[20px] ml-[50px] mr-4">
        <img class="w-full rounded" src="./../static/Lowro_ (twitter).png">
        <p class="text-black dark:text-white text-center mt-2">Positive</p>
      </div>
      <div class="mt-[20px] ml-4 mr-[50px]">
        <img class="w-full rounded" src="./../static/Lowro_ (twitter).png">
        <p class="text-black dark:text-white text-center mt-2">Negative</p>
      </div>
    </div>
  </div>
</div>
{% endblock %}
